"use client";
import { useState, useEffect } from 'react';
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Table, TableBody, TableCaption, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";

// Google Drive API configuration
const CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID';
const API_KEY = 'YOUR_GOOGLE_API_KEY';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

// Mock payment history data
let mockPayments = [
  { id: 1, tourId: 'TOUR-2023-001', type: 'traveler', name: 'Rahul Sharma', amount: 15000, status: 'advance', date: '2023-05-15', mode: 'upi', bankName: 'HDFC Bank', upiId: 'rahul@hdfc' },
  { id: 2, tourId: 'TOUR-2023-001', type: 'vendor', vendorType: 'hotel', name: 'Taj Hotels', amount: 50000, status: 'partial', date: '2023-05-20', mode: 'check', bankName: 'SBI' },
  { id: 3, tourId: 'TOUR-2023-002', type: 'vendor', vendorType: 'air-service', name: 'Air India', amount: 75000, status: 'full', date: '2023-06-10', mode: 'credit-card' },
];

export default function PaymentManagement() {
  // Form state
  const [tourId, setTourId] = useState('');
  const [paymentType, setPaymentType] = useState<'traveler' | 'vendor'>('traveler');
  const [vendorType, setVendorType] = useState('');
  const [paymentMode, setPaymentMode] = useState('');
  const [amount, setAmount] = useState('');
  const [reference, setReference] = useState('');
  const [bankName, setBankName] = useState('');
  const [upiId, setUpiId] = useState('');
  const [date, setDate] = useState('');
  const [travelerName, setTravelerName] = useState('');
  const [vendorName, setVendorName] = useState('');
  const [paymentStatus, setPaymentStatus] = useState<'advance' | 'partial' | 'full'>('advance');
  const [submitted, setSubmitted] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState('');
  const [activeTab, setActiveTab] = useState<'form' | 'history'>('form');
  const [gapiLoaded, setGapiLoaded] = useState(false);
  const [googleAuth, setGoogleAuth] = useState<any>(null);
  const [isSignedIn, setIsSignedIn] = useState(false);

  // Load Google API client
  useEffect(() => {
    const script = document.createElement('script');
    script.src = 'https://apis.google.com/js/api.js';
    script.async = true;
    script.defer = true;
    script.onload = () => {
      window.gapi.load('client:auth2', () => {
        window.gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: [DISCOVERY_DOC],
          scope: SCOPES
        }).then(() => {
          setGapiLoaded(true);
          const auth = window.gapi.auth2.getAuthInstance();
          setGoogleAuth(auth);
          setIsSignedIn(auth.isSignedIn.get());
          auth.isSignedIn.listen(setIsSignedIn);
        });
      });
    };
    document.body.appendChild(script);

    return () => {
      document.body.removeChild(script);
    };
  }, []);

  // Set default date to today
  useEffect(() => {
    const today = new Date().toISOString().split('T')[0];
    setDate(today);
  }, []);

  const handleGoogleSignIn = () => {
    if (googleAuth) {
      googleAuth.signIn();
    }
  };

  const handleGoogleSignOut = () => {
    if (googleAuth) {
      googleAuth.signOut();
    }
  };

  const saveToGoogleDrive = async (data: any) => {
    if (!gapiLoaded || !isSignedIn) {
      console.error('Google API not loaded or user not signed in');
      return;
    }

    try {
      // Convert data to CSV format
      const headers = Object.keys(data).join(',');
      const values = Object.values(data).join(',');
      const csvContent = `${headers}\n${values}`;
      const blob = new Blob([csvContent], { type: 'text/csv' });
      
      // Create form data
      const metadata = {
        name: `payment_${data.tourId}_${Date.now()}.csv`,
        mimeType: 'text/csv',
        parents: ['root'] // You can specify folder ID here if needed
      };

      const formData = new FormData();
      formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      formData.append('file', blob);

      const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${googleAuth.currentUser.get().getAuthResponse().access_token}`
        },
        body: formData
      });

      if (!response.ok) {
        throw new Error('Failed to upload to Google Drive');
      }

      return await response.json();
    } catch (error) {
      console.error('Error saving to Google Drive:', error);
      throw error;
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);
    setError('');

    // Validation
    if (!tourId) {
      setError('Please enter Tour ID');
      setIsSubmitting(false);
      return;
    }
    if (!amount || isNaN(Number(amount))) {
      setError('Please enter a valid amount');
      setIsSubmitting(false);
      return;
    }
    if (!reference) {
      setError('Please enter a reference');
      setIsSubmitting(false);
      return;
    }
    if ((paymentMode === 'bank-transfer' || paymentMode === 'check' || paymentMode === 'upi') && !bankName) {
      setError('Please enter bank name for this payment mode');
      setIsSubmitting(false);
      return;
    }
    if (paymentMode === 'upi' && !upiId) {
      setError('Please enter UPI ID');
      setIsSubmitting(false);
      return;
    }

    // Prepare payment data
    const paymentData = {
      id: Date.now(),
      tourId,
      type: paymentType,
      ...(paymentType === 'vendor' && { vendorType }),
      name: paymentType === 'traveler' ? travelerName : vendorName,
      amount: Number(amount),
      status: paymentStatus,
      date,
      mode: paymentMode,
      reference,
      ...(bankName && { bankName }),
      ...(paymentMode === 'upi' && { upiId })
    };

    try {
      // Save to Google Drive if signed in
      if (isSignedIn) {
        await saveToGoogleDrive(paymentData);
      }

      // Add to mock payments (in a real app, this would be your database)
      mockPayments = [...mockPayments, paymentData];

      setSubmitted(true);
    } catch (error) {
      setError('Failed to save payment. Please try again.');
      console.error('Submission error:', error);
    } finally {
      setIsSubmitting(false);
    }
  };

  const resetForm = () => {
    setTourId('');
    setPaymentType('traveler');
    setVendorType('');
    setPaymentMode('');
    setAmount('');
    setReference('');
    setBankName('');
    setUpiId('');
    setDate(new Date().toISOString().split('T')[0]);
    setTravelerName('');
    setVendorName('');
    setPaymentStatus('advance');
    setSubmitted(false);
    setError('');
  };

  const formatCurrency = (value: number) => {
    return new Intl.NumberFormat('en-IN', {
      style: 'currency',
      currency: 'INR',
      minimumFractionDigits: 0
    }).format(value).replace('‚Çπ', '‚Çπ ');
  };

  const getVendorIcon = (type: string) => {
    switch(type) {
      case 'air-service':
        return <div className="bg-blue-100 p-2 rounded-lg flex items-center justify-center">
          <div className="bg-gray-200 border-2 border-dashed rounded-xl w-16 h-16" />
          <span className="ml-2">‚úàÔ∏è</span>
        </div>;
      case 'hotel':
        return <div className="bg-green-100 p-2 rounded-lg flex items-center justify-center">
          <div className="bg-gray-200 border-2 border-dashed rounded-xl w-16 h-16" />
          <span className="ml-2">üè®</span>
        </div>;
      case 'visa':
        return <div className="bg-purple-100 p-2 rounded-lg flex items-center justify-center">
          <div className="bg-gray-200 border-2 border-dashed rounded-xl w-16 h-16" />
          <span className="ml-2">üõÇ</span>
        </div>;
      default:
        return <div className="bg-gray-100 p-2 rounded-lg flex items-center justify-center">
          <div className="bg-gray-200 border-2 border-dashed rounded-xl w-16 h-16" />
        </div>;
    }
  };

  if (submitted) {
    return (
      <Card className="w-full max-w-4xl mx-auto mt-8">
        <CardHeader>
          <CardTitle className="text-2xl">Payment Submitted</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="p-4 bg-green-50 rounded-lg">
            <p className="text-green-700 font-medium">
              Payment submitted successfully!
              {isSignedIn ? ' Saved to Google Drive.' : ' (Not saved to Google Drive - not signed in)'}
            </p>
            <div className="mt-4 space-y-2 text-sm">
              <p><span className="font-semibold">Payment Type:</span> {paymentType === 'traveler' ? 'Traveler' : 'Vendor'}</p>
              <p><span className="font-semibold">Date:</span> {date}</p>
              <p><span className="font-semibold">Tour ID:</span> {tourId}</p>
              {paymentType === 'vendor' && (
                <>
                  <p><span className="font-semibold">Vendor Type:</span> {vendorType}</p>
                  {getVendorIcon(vendorType)}
                </>
              )}
              <p><span className="font-semibold">Payment Status:</span> {paymentStatus.charAt(0).toUpperCase() + paymentStatus.slice(1)}</p>
              <p><span className="font-semibold">Mode:</span> {paymentMode}</p>
              {bankName && <p><span className="font-semibold">Bank Name:</span> {bankName}</p>}
              {paymentMode === 'upi' && <p><span className="font-semibold">UPI ID:</span> {upiId}</p>}
              <p><span className="font-semibold">Amount:</span> {formatCurrency(Number(amount))}</p>
              <p><span className="font-semibold">Reference:</span> {reference}</p>
            </div>
          </div>
          <div className="flex gap-4">
            <Button onClick={resetForm} className="flex-1">
              Create New Payment
            </Button>
            <Button 
              onClick={() => setActiveTab('history')} 
              variant="outline" 
              className="flex-1"
            >
              View History
            </Button>
          </div>
        </CardContent>
      </Card>
    );
  }

  if (activeTab === 'history') {
    return (
      <Card className="w-full max-w-4xl mx-auto mt-8">
        <CardHeader>
          <div className="flex justify-between items-center">
            <CardTitle className="text-2xl">Payment History</CardTitle>
            <div className="flex gap-2">
              {!isSignedIn ? (
                <Button onClick={handleGoogleSignIn} variant="outline">
                  Sign in to Google Drive
                </Button>
              ) : (
                <Button onClick={handleGoogleSignOut} variant="outline">
                  Sign out of Google
                </Button>
              )}
              <Button onClick={() => setActiveTab('form')} variant="outline">
                Back to Payment Form
              </Button>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          <Table>
            <TableCaption>A list of recent payments {!isSignedIn && '(Sign in to Google Drive to save payments)'}</TableCaption>
            <TableHeader>
              <TableRow>
                <TableHead>Date</TableHead>
                <TableHead>Tour ID</TableHead>
                <TableHead>Type</TableHead>
                <TableHead>Name</TableHead>
                <TableHead>Amount</TableHead>
                <TableHead>Status</TableHead>
                <TableHead>Mode</TableHead>
                <TableHead>Bank/UPI</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {mockPayments.map((payment) => (
                <TableRow key={payment.id}>
                  <TableCell>{payment.date}</TableCell>
                  <TableCell>{payment.tourId}</TableCell>
                  <TableCell>
                    {payment.type === 'traveler' ? 'Traveler' : 
                    `${payment.vendorType?.charAt(0)?.toUpperCase() + payment.vendorType?.slice(1)}`}
                  </TableCell>
                  <TableCell>{payment.name}</TableCell>
                  <TableCell>{formatCurrency(payment.amount)}</TableCell>
                  <TableCell>
                    <span className={`px-2 py-1 rounded-full text-xs ${
                      payment.status === 'full' ? 'bg-green-100 text-green-800' :
                      payment.status === 'partial' ? 'bg-yellow-100 text-yellow-800' :
                      'bg-blue-100 text-blue-800'
                    }`}>
                      {payment.status.charAt(0).toUpperCase() + payment.status.slice(1)}
                    </span>
                  </TableCell>
                  <TableCell>
                    {payment.mode.split('-').map(word => 
                      word.charAt(0).toUpperCase() + word.slice(1)
                    ).join(' ')}
                  </TableCell>
                  <TableCell>
                    {payment.mode === 'upi' ? payment.upiId : (payment.bankName || '-')}
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card className="w-full max-w-4xl mx-auto mt-8">
      <CardHeader>
        <CardTitle className="text-2xl">Payment Management</CardTitle>
        {!isSignedIn && (
          <div className="text-sm text-yellow-600">
            Note: You're not signed in to Google Drive. Payments won't be saved to cloud storage.
          </div>
        )}
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-6">
          {error && (
            <div className="p-4 bg-red-50 text-red-700 rounded-lg">
              {error}
            </div>
          )}

          <div className="space-y-2">
            <Label>Payment Type</Label>
            <RadioGroup
              value={paymentType}
              onValueChange={(value: 'traveler' | 'vendor') => setPaymentType(value)}
              className="flex gap-4"
            >
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="traveler" id="traveler" />
                <Label htmlFor="traveler">Traveler</Label>
              </div>
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="vendor" id="vendor" />
                <Label htmlFor="vendor">Vendor</Label>
              </div>
            </RadioGroup>
          </div>

          <div className="space-y-2">
            <Label htmlFor="date">Date *</Label>
            <Input
              id="date"
              type="date"
              value={date}
              onChange={(e) => setDate(e.target.value)}
              required
            />
          </div>

          <div className="space-y-2">
            <Label htmlFor="tour-id">Tour ID *</Label>
            <Input
              id="tour-id"
              value={tourId}
              onChange={(e) => setTourId(e.target.value)}
              placeholder="Enter Tour ID (e.g. TOUR-2023-001)"
              required
            />
          </div>

          {paymentType === 'traveler' && (
            <div className="space-y-2">
              <Label htmlFor="traveler-name">Traveler Name *</Label>
              <Input
                id="traveler-name"
                value={travelerName}
                onChange={(e) => setTravelerName(e.target.value)}
                placeholder="Enter traveler name"
                required
              />
            </div>
          )}

          {paymentType === 'vendor' && (
            <>
              <div className="space-y-2">
                <Label htmlFor="vendor-type">Vendor Type *</Label>
                <Select
                  value={vendorType}
                  onValueChange={setVendorType}
                  required
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select vendor type" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="air-service">
                      <div className="flex items-center">
                        <span className="mr-2">‚úàÔ∏è</span> Air Service
                      </div>
                    </SelectItem>
                    <SelectItem value="hotel">
                      <div className="flex items-center">
                        <span className="mr-2">üè®</span> Hotel
                      </div>
                    </SelectItem>
                    <SelectItem value="visa">
                      <div className="flex items-center">
                        <span className="mr-2">üõÇ</span> Visa
                      </div>
                    </SelectItem>
                    <SelectItem value="other">Other</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {vendorType && (
                <div className="flex items-center justify-center">
                  {getVendorIcon(vendorType)}
                </div>
              )}

              <div className="space-y-2">
                <Label htmlFor="vendor-name">Vendor Name *</Label>
                <Input
                  id="vendor-name"
                  value={vendorName}
                  onChange={(e) => setVendorName(e.target.value)}
                  placeholder="Enter vendor name"
                  required
                />
              </div>
            </>
          )}

          <div className="space-y-2">
            <Label htmlFor="payment-status">Payment Status *</Label>
            <Select
              value={paymentStatus}
              onValueChange={(value: 'advance' | 'partial' | 'full') => setPaymentStatus(value)}
              required
            >
              <SelectTrigger>
                <SelectValue placeholder="Select payment status" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="advance">Advance</SelectItem>
                <SelectItem value="partial">Partial</SelectItem>
                <SelectItem value="full">Full</SelectItem>
              </SelectContent>
            </Select>
          </div>

          <div className="space-y-2">
            <Label htmlFor="payment-mode">Payment Mode *</Label>
            <Select
              value={paymentMode}
              onValueChange={setPaymentMode}
              required
            >
              <SelectTrigger>
                <SelectValue placeholder="Select payment mode" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="cash">Cash</SelectItem>
                <SelectItem value="check">Check</SelectItem>
                <SelectItem value="bank-transfer">Bank Transfer</SelectItem>
                <SelectItem value="upi">UPI</SelectItem>
                <SelectItem value="credit-card">Credit Card</SelectItem>
              </SelectContent>
            </Select>
          </div>

          <div className="space-y-2">
            <Label htmlFor="amount">Amount (‚Çπ) *</Label>
            <Input
              id="amount"
              type="number"
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              placeholder="0.00"
              step="0.01"
              required
            />
          </div>

          {(paymentMode === 'bank-transfer' || paymentMode === 'check' || paymentMode === 'upi') && (
            <div className="space-y-2">
              <Label htmlFor="bank-name">Bank Name *</Label>
              <Input
                id="bank-name"
                value={bankName}
                onChange={(e) => setBankName(e.target.value)}
                placeholder="Enter bank name"
                required
              />
            </div>
          )}

          {paymentMode === 'upi' && (
            <div className="space-y-2">
              <Label htmlFor="upi-id">UPI ID *</Label>
              <Input
                id="upi-id"
                value={upiId}
                onChange={(e) => setUpiId(e.target.value)}
                placeholder="Enter UPI ID (e.g. name@upi)"
                required
              />
            </div>
          )}

          <div className="space-y-2">
            <Label htmlFor="reference">Reference *</Label>
            <Input
              id="reference"
              value={reference}
              onChange={(e) => setReference(e.target.value)}
              placeholder="Payment reference"
              required
            />
          </div>

          <div className="flex gap-4">
            <Button type="submit" className="flex-1" disabled={isSubmitting}>
              {isSubmitting ? 'Processing...' : 'Submit Payment'}
            </Button>
            <Button 
              onClick={() => setActiveTab('history')} 
              variant="outline" 
              className="flex-1"
            >
              View History
            </Button>
          </div>

          {!isSignedIn && (
            <div className="text-center">
              <Button 
                onClick={handleGoogleSignIn} 
                variant="secondary" 
                className="w-full"
              >
                Sign in to Google Drive to Save Payments
              </Button>
            </div>
          )}
        </form>
      </CardContent>
    </Card>
  );
}