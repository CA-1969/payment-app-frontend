<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Traveler Payment Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; }
        .modal-bg { background: rgba(28,28,40,0.38);}
        .modal-frame { background: #fff; border-radius: 10px; box-shadow: 0 8px 48px #1f293733; width: 98vw; max-width:1020px; min-height:600px;}
        .modal-close { position:absolute; top:10px; right:22px; font-size:26px; font-weight:bold; color:#444; cursor:pointer; background:none; border:none;}
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-8">
<div class="w-full max-w-3xl">

    <!-- Header -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-200 mb-6 overflow-hidden">
        <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-blue-600 to-indigo-700 text-white rounded-t-xl">
            <h2 class="text-3xl font-extrabold text-center">Traveler Payment Management</h2>
            <p class="text-blue-100 text-center mt-1 text-md"> - Payments & Invoice Integration - </p>
        </div>
    </div>

    <!-- Traveler Payment Form -->
    <form id="paymentForm" class="bg-white rounded-xl shadow-lg border border-gray-200 p-8 space-y-6">
        <div class="space-y-4">
            <!-- Tour ID -->
            <div>
                <label for="tourId" class="block mb-1 font-semibold text-gray-700">Tour ID <span class="text-red-500">*</span></label>
                <input type="text" id="tourId" name="tourId" required class="h-10 w-full rounded-lg border border-gray-300 bg-white px-3 focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
                <label for="travelerName" class="block mb-1 font-semibold text-gray-700">Traveler/Group Name <span class="text-red-500">*</span></label>
                <input type="text" id="travelerName" name="travelerName" required class="h-10 w-full rounded-lg border border-gray-300 bg-white px-3 focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
                <label for="totalAmount" class="block mb-1 font-semibold text-gray-700">Amount (₹) <span class="text-red-500">*</span></label>
                <input type="number" id="totalAmount" name="totalAmount" required min="0" step="0.01" class="h-10 w-full rounded-lg border border-gray-300 bg-white px-3 focus:ring-2 focus:ring-blue-500" />
            </div>
            <div>
                <label for="otherDetails" class="block mb-1 font-semibold text-gray-700">Other Details</label>
                <input type="text" id="otherDetails" name="otherDetails" class="h-10 w-full rounded-lg border border-gray-300 bg-white px-3 focus:ring-2 focus:ring-blue-500" />
            </div>
        </div>

        <!-- ===== DD INVOICE INTEGRATION ===== -->
        <div class="flex flex-col w-full mt-4 gap-2">
            <button
                type="button"
                id="raiseInvoiceBtn"
                class="px-5 py-2 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 shadow-md transition-all duration-150"
                onclick="openInvoiceModal();"
            >
                Do you want to raise an Invoice also?
            </button>
            <button
                type="button"
                id="showInvoiceBtn"
                class="mt-1 px-5 py-2 rounded-lg font-bold text-indigo-700 bg-white border border-indigo-200 hover:bg-indigo-50"
                onclick="showPreviousInvoice();"
            >
                Show Invoice for This Tour
            </button>
        </div>
        <!-- === END DD INVOICE INTEGRATION === -->

        <div class="flex justify-center mt-8">
            <button type="submit" class="w-full md:w-auto px-8 py-3 text-lg rounded-full font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-xl">
                Submit Payment
            </button>
        </div>
        <div id="submitResultMessage" class="hidden p-4 mt-6 rounded-lg text-center font-medium"></div>
    </form>
</div>

<!-- INVOICE MODAL (hidden initially) -->
<div id="invoiceModalBg" style="display:none; position:fixed; inset:0; z-index:999;" class="modal-bg flex items-center justify-center">
    <div class="modal-frame relative border border-gray-200" style="max-height:92vh;">
        <button class="modal-close" onclick="closeInvoiceModal()">×</button>
        <iframe
           id="invoiceFrame"
           src=""
           style="width:100%; min-height:84vh; border:none; border-radius:10px;"
           title="Invoice"
        ></iframe>
    </div>
</div>

<script>
const DD_INVOICE_URL = "https://YOUR_GITHUB_USER.github.io/YOUR_REPO/dd_invoice.html"; // use your true GitHub Pages path

function openInvoiceModal() {
    // Fetch fields
    const tid = document.getElementById('tourId').value.trim();
    const tname = document.getElementById('travelerName').value.trim();
    const amt = document.getElementById('totalAmount').value.trim();
    const details = document.getElementById('otherDetails').value.trim();
    // Send to localStorage (for cross-tab); DD_Invoice will auto-pick up and clear
    localStorage.setItem("dd_invoice_prefill", JSON.stringify({
      tourId: tid,
      travelerName: tname,
      amount: amt,
      otherDetails: details
    }));
    // Open in modal (iframe). Fallback: open in new tab if popups disabled
    document.getElementById('invoiceFrame').src = DD_INVOICE_URL;
    document.getElementById('invoiceModalBg').style.display = "flex";
    // Also copy as query params (fallback if localStorage fails):
    // document.getElementById('invoiceFrame').src = DD_INVOICE_URL + "?tourId=" + encodeURIComponent(tid) + "&tname=" + encodeURIComponent(tname) + "&amt=" + encodeURIComponent(amt) + "&details=" + encodeURIComponent(details);
}
function closeInvoiceModal() {
    document.getElementById('invoiceModalBg').style.display = "none";
    document.getElementById('invoiceFrame').src = "";
}

function showPreviousInvoice() {
    const tid = document.getElementById('tourId').value.trim();
    if (!tid) {
        alert("Please enter Tour ID to view invoice.");
        return;
    }
    localStorage.setItem("dd_invoice_prefill", JSON.stringify({ tourId: tid }));
    // You must ensure dd_invoice.html supports ?mode=lookup or similar (see dd_invoice.html below)
    window.open(DD_INVOICE_URL + "?lookup=1&tourId=" + encodeURIComponent(tid), "_blank");
}

// Modal/escape handler
document.addEventListener('keydown', function(ev) {
    if (ev.key === "Escape") closeInvoiceModal();
});
</script>
</body>
</html>
